programs = hapi hapi-compile
name = hapi
version = 2018
compiler = g++
opt = -O3
args = -std=c++11 $(opt) `sdl-config --cflags`
libs = -lhapi -lSDL_net
#GUI_SDLlibs = -lhapi -lsdlwidgets
OS_AUTO = $(shell uname -s)
COMMENT = _

default:
	echo "Use: make config, make build, make install, make clean, and if you don't like it make uninstall."

phony: config build install uninstall clean tags

config: include/config.hpp
ifeq ($(GUI),sdl)
	sed -e "s/#GUI$(COMMENT)SDL//g" Makefile.in > Makefile.tmp
else
	sed -e "s/#GUI$(COMMENT)HTTP//g" Makefile.in > Makefile.tmp
endif
ifeq ($(OS),linux)
	sed -e "s/#OS$(COMMENT)LINUX//g" Makefile.tmp > Makefile
else
ifeq ($(OS),osx)
	sed -e "s/#OS$(COMMENT)MAC//g" Makefile.tmp > Makefile
else
ifeq ($(OS_AUTO),Linux)
	sed -e "s/#OS$(COMMENT)LINUX//g" Makefile.tmp > Makefile
else
ifeq ($(OS_AUTO),Darwin)
	sed -e "s/#OS$(COMMENT)MAC//g" Makefile.tmp > Makefile
else
	echo "Unable to recognize os $(OS_AUTO)."
	echo "If linux is used please run"
	echo "OS=linux make config."
	echo "If OS X is used please run"
	echo "OS=osx make config."
	cp Makefile.in Makefile
endif
endif
endif
endif
	rm Makefile.tmp

build: $(programs)

install: $(programs)
	cp $(programs) /usr/local/bin/

uninstall:
	rm -f /usr/local/bin/hapi /usr/local/bin/hapi-compile

include/config.hpp: Makefile
	mkdir -p include
	echo "// Autogenerated configuration file" > include/config.hpp
	echo "#ifndef CONFIG_HPP" >> include/config.hpp
	echo "#define CONFIG_HPP" >> include/config.hpp
#OS_MAC	echo "#define OS_MAC" >> include/config.hpp
	echo "#define OS_LINUX" >> include/config.hpp
#OS_WIN	echo "#define OS_WIN" >> include/config.hpp
#GLOOX_VER_0.8.8	echo "#define GLOOX_0_8_8" >> include/config.hpp
#GLOOX_VER_0.9.0	echo "#define GLOOX_0_9_0" >> include/config.hpp
#GLOOX_VER_0.9.6	echo "#define GLOOX_0_9_6" >> include/config.hpp
	echo "#endif" >> include/config.hpp

clean:
	touch clean~
	touch packages
	touch debs
	touch $(programs)
	rm *~
	rm -Rf packages
	rm -Rf debs
	rm -Rf objects
	rm -f include/config.hpp
	rm $(programs)
	cp Makefile.in Makefile

objects/%.o: source/%.cpp include/*.hpp include/config.hpp
	mkdir -p objects
	$(compiler) -c source/$*.cpp $(args) -o objects/$*.o

hapi-compile: source/hapi-compile
	cp source/hapi-compile ./hapi-compile

%: $(objects) objects/%.o include/config.hpp
	$(compiler) objects/$*.o $(objects) -o $* $(args) $(libs)

deb: $(programs)
	echo "Making DEB package"
	mkdir -p debs/
	echo "Making data folder"
	mkdir -p debs/$(name)_$(version)_i386
	mkdir -p debs/$(name)_$(version)_i386/usr
	mkdir -p debs/$(name)_$(version)_i386/usr/local
	mkdir -p debs/$(name)_$(version)_i386/usr/local/bin
	cp $(programs) debs/$(name)_$(version)_i386/usr/local/bin/
	echo "Making control"
	mkdir -p debs/$(name)_$(version)_i386/DEBIAN
	echo "Package: $(name)"                                         > debs/$(name)_$(version)_i386/DEBIAN/control
	echo "Version: $(version)"                                     >> debs/$(name)_$(version)_i386/DEBIAN/control
	echo "Architecture: i386"                                      >> debs/$(name)_$(version)_i386/DEBIAN/control
	echo "Maintainer: Lasse Nielsen <lasse.nielsen.dk@gmail.com>"  >> debs/$(name)_$(version)_i386/DEBIAN/control
	echo "Installed-Size: 1024"                                    >> debs/$(name)_$(version)_i386/DEBIAN/control
	echo "Pre-Depends: dpkg (>= 1.14.12ubuntu3)"                   >> debs/$(name)_$(version)_i386/DEBIAN/control
	echo "Depends: libhapi (>= $(version)), libpi (>= $(version)), g++">> debs/$(name)_$(version)_i386/DEBIAN/control
	echo "Recommends: "                                            >> debs/$(name)_$(version)_i386/DEBIAN/control
	echo "Suggests: "                                              >> debs/$(name)_$(version)_i386/DEBIAN/control
	echo "Conflicts: "                                             >> debs/$(name)_$(version)_i386/DEBIAN/control
	echo "Replaces: "                                              >> debs/$(name)_$(version)_i386/DEBIAN/control
	echo "Provides: hapi"                                         >> debs/$(name)_$(version)_i386/DEBIAN/control
	echo "Section: interpretor"                                    >> debs/$(name)_$(version)_i386/DEBIAN/control
	echo "Priority: optional"                                      >> debs/$(name)_$(version)_i386/DEBIAN/control
	echo "Homepage: http://www.thelas.dk"                          >> debs/$(name)_$(version)_i386/DEBIAN/control
	echo "Description: Interpretor for the Hapi Language."        >> debs/$(name)_$(version)_i386/DEBIAN/control
	echo "chmod a+x /usr/local/bin/hapi-compile"                   > debs/$(name)_$(version)_i386/DEBIAN/postinst
	chmod a+x debs/$(name)_$(version)_i386/DEBIAN/postinst
	@echo "Finalizing package"
	dpkg -b debs/$(name)_$(version)_i386/
	rm -Rf debs/$(name)_$(version)_i386

